---
title: "Practical- Introduction to Statistics"
author: "Maria Anastasiadi"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages
```{r}
library(tidyverse)
#library(olsrr)
library(car)
library(ggpubr)
library(rstatix)
library(pwr)
```

```{r}
#setwd("Provide the path to your working directory here")
```


# Introduction

Today’s Practical will focus on practicing on two other types of ANOVA that you may encounter during your studies: Two-way ANOVA and Mixed ANOVA 


## Two-Way ANOVA 
As we have seen so far one-way ANOVA allows us to determine whether there are significant differences between the effects of two or more treatments. The treatments we are interested in comparing are the different levels of a factor. For example, we can assess the effect of different types of diet on blood glucose levels. However, we may also be interested in assessing the effect of both sex and diet on blood glucose levels. To design such an experiment, we need to have a group of males and a group of females and randomly assign the members of each group to the different types of diet. This is called a two-factor experiment because we examine two different kinds of factors (diet and sex). Fortunately, the principles of ANOVA that you have seen already can be extended to provide a powerful and elegant way of analysing data from factorial designs. This approach is referred to as two-way ANOVA (also known as two-factor ANOVA).<br>
A two-way ANOVA on data from the diet experiment above would tell us whether blood glucose levels are affected by (a) diet and (b) sex, and (c) whether the effect of diet depends on sex (and vice versa). So instead of just one result (as we get from a one-way ANOVA) there are now three to consider. The effect of diet and of sex are termed **main effects** and the effect of each diet type / sex combination is termed the **interaction**. As a result, there are three hypotheses associated with a two-way ANOVA. There are two hypotheses for the tests for the main effects (Null Hypothesis 1: Diet has no effect on blood glucose levels, Null Hypothesis 2: Sex has no effect on blood glucose levels) as well as a hypothesis for the interaction test (Null hypothesis 3: The interaction Diet*Sex has no effect on blood glucose levels). 

**Aim**: Employ two-way ANOVA for comparing means for combinations of two independent categorical variables (Sex and Diet) and their interaction on blood glucose levels. 

## Task 1. 
Import the `Diet.csv` data into the R environment. Call the data frame `diet.data`. The file contains data on the weight and fasting blood glucose levels in 72 subjects (36 male, 36 female) over 50 years old categorised as pre-diabetic, before and after 6 months on one of the three different diets (“V”, “M”, “P”). 
```{r}
diet.data <- read.table(sep=, header=, row.names=, stringsAsFactors = FALSE)
```

## Task2.
Inspect the dataframe and Generate Descriptive Statistics.
```{r}
dplyr::glimpse()
```

If the variables `Diet` and `Sex` are not factors then convert them into factors. You can do it as follows:
```{r}
diet.data <- dplyr::mutate_at(diet.data, vars(Diet, Sex), as.factor)
```


## Task 3. 
Calculate the difference in Blood Glucose levels before and after the diet and add the new variable to the dataset. Name the new column `BGReduction`. 
```{r}
diet.data <- dplyr::mutate(diet.data, BGReduction = ) # define the new variable BGReduction
```

## Task 4. 
Create QQ plots for each group (Diet/Sex combination) to check if the assumption of normality stands.

```{r}
ggplot(data = diet.data, aes(sample = BGReduction)) +    
  geom_qq() +                               
  stat_qq_line() +                          
  facet_wrap(Diet~Sex,                   # Panel by group
             labeller = label_both) +    
  theme_bw()  
```
 
## Task 5. 
Create a boxplot to inspect the spread of values for each sex/diet group.
```{r}
ggplot(data = , aes(x = ,               # Fill in the missing variables
             y = , colour = Sex)) +   
  geom_boxplot(width = 0.5,
               fill = "white") +
  theme_bw()
```

## Task 6.
Carry out a two-way ANOVA with an interaction using the function `aov()`. Name the new model `diet.anova`. 
*Hint*: to add an interaction in the anova formula, multiply the two factors. 
```{r}
diet.anova <-aov()   # add the arguments in the anova function
summary(diet.anova)
```

**Question1**: Which are the *dependent* variables and which are the *independent* variables in the anova formula? **Question2**: Are the main effects significant?
**Question3**: Is the interaction significant?

## Task 7
Check the ANOVA assumptions for the residuals. If they are not met consider a transformation. Else, proceed to the next task. 

## Task 8
If the interaction is significant, go ahead and apply Tukey Test for pairwise comparisons.
```{r}

```


**Questions** Which groups (Diet/Sex) have statistically significant differences in Blood Glucose Reduction?

## Task 9. Create interactions plot. 
The easiest way to interpret the interaction is to use a means or interaction plot which shows the means for each combination of diet and sex. If there is no interaction the means plots for the main effects are parallel. 

First create a factor to contain the sex values, with levels=c("M", "F") 
```{r}
Sex <-diet.data$Sex  # remember we have already converted the variable sex into a factor
```

Then plot the interactions
```{r}
interaction.plot(diet.data$Diet,Sex,diet.data$BGReduction, type="b",col=c(2:3),leg.bty="n",lwd=2, pch=c(1,24),xlab="Diet",ylab="Blood Glucose Reduction", main="Interaction plot")
```

## Task 10. Calculate effect size
To calculate the effect size we can use the $$η^2$$ metric which provides the % of variance explained by each of the main effects and their interaction. 
```{r}
library(lsr)
etaSquared( diet.anova )
```
Question: Which factor has the highest effect on the BGReduction variable?

# 1.3 Mixed ANOVA
The final example we will encounter in today's practical is an experiment which requires Mixed ANOVA. In this experiment we subjected rapeseed oil (*Brassica napus*) plants into heat stress for 24 h period and then recorded the changes in the metabolite progoitrin over time. Progoitrin is a glucosinolate found in *Brassicas* and is a precursor to goitrin which is known for its anti-thyroid effects. <br>
The reason we need to use mixed ANOVA over simple two-way ANOVA is that we sample from the same plants at each timepoint, so the samples are not independent! <br>
For this exercise we will use the package `ggpubr` and `rstatix`. 

## Task 1.
Load the dataset PRO into the R environment and name the dataframe `pro.data`.

```{r}
pro.data <- 
```
The variable `PRO` contains the concentrations of progoitrin (μg/g DW), the column `Treatment` contains the treatment (C=Control, H = Heat Stress) and the column `Timepoint` contains the day of sampling.

## Task 2. 
Inspect the dataframe and generate Descriptive Statistics.
```{r}

```

## Task 3.
Convert the columns ID, Treatment and Timepoint into factors
```{r}


```

## Task 4.
Generate frequency tablesto check the number of replicates per group:
```{r}
table(pro.data$Treatment, pro.data$Timepoint) 
```


## Task 5.
Produce a boxplot to visualise the variation in progoitrin concentrations among groups (Treatment/Timepoint)
```{r}
ggboxplot(pro.data, x = "Timepoint", y = "PRO", color = "Treatment", ylab="PRO conc.(ng/g)",
          palette = c("#00AFBB", "#E7B800", "#FC4E07"), main= "PRO conc.before outliers substitution with mean"
          )
```


## Task 6
Identify outliers: The boxplot you created in Task 5 should show some datapoints located far from the boxplot whiskers. These are suspected outliers. To identify them you can use the function `identify_outliers()` which is based on boxplot methods.<br>
Values above Q3 + 1.5xIQR or below Q1 - 1.5xIQR are considered as outliers. Values above Q3 + 3xIQR or below Q1 - 3xIQR are considered as extreme outliers. <br>
Q1 and Q3 are the first and third quartile, respectively. IQR is the interquartile range (IQR = Q3 - Q1).<br>

To identify outliers and extreme outlier run the code below:
```{r}
outl <-pro.data %>%
  group_by(Treatment, Timepoint) %>%
  identify_outliers("PRO") 
  print(outl)
```

Create a vector containing the `Identifier` values for the outliers contained in `outl`. Call the vector `outl.list`
```{r}

```

## Task 7. 
Replace outliers. Usually we would choose to completely remove the outliers. You could easily remove the outliers as shown here: 
```{r, eval=FALSE}
#pro.data <- pro.data %>% 
#  anti_join(outl, by = ("ID"))
```

However, for the Mixed ANOVA to work we need a balance design. Therefore we can replace the outliers with a different value. We have many choices for replacing outliers. A simple choice is to replace them with the median of each group of the variable `PRO`. In this case, we will choose to replace only the outliers with Identifier 39 and 47 since they are the most extreme and also there is only one outlier out of the 5 replicates. This is an indication that the extreme values are a result of computational or technical error rather than biological variability. 

a) Find the Median of variable `PRO` for each group.
```{r}
pro.filt.5 <-dplyr::filter(pro.data, Treatment == "H", Timepoint=="5")
pro.filt.6 <-dplyr::filter(pro.data, Treatment == "H", Timepoint=="6")
median.pro.5 <- median(pro.filt.5$PRO)
median.pro.6 <- median(pro.filt.6$PRO)
```

b) Then run the code chunk below to replace the outliers with the respective median values. 
```{r}
#pro.data$PRO = ifelse(pro.filt$Identifier %in% as.vector(outl.list), median.pro, pro.data$PRO)
pro.data$PRO[pro.data$Identifier== 39] = median.pro.5
pro.data$PRO[pro.data$Identifier== 47] = median.pro.6
```

## Task 8.
Create a boxplot after outlier removal to see the effect of the pre-treatment on the spread of the progoitrin concentrations. 
```{r}

```

## Task 9. 
Produce QQ plots for each group to check normality of data.
```{r}

```

**Question**: Can we accept the assumption of normality? 

To make sure we can conduct a Shapiro-Wilk test

```{r}
pro.data %>%
  group_by(Treatment, Timepoint) %>%
  shapiro_test(PRO)
```

## Task 10.Two-Way Mixed ANOVA Analysis
To perform mixed ANOVA use the function `anova_test()` from the package `rstatix` which is simply a wrapper for the `aov()` function you have used already, but makes thing a little easier for more complex statistical designs. Check the `help()` for this function to see how it is used. 
```{r}
pro.anova <- anova_test(data = pro.data, dv = "PRO", wid = ID, between = Treatment, within = Timepoint, type=2)
```

Run the following chunk of code to create and print an ANOVA table for the model you created above:
```{r}
aov.results_PRO <- get_anova_table(pro.anova)
anova.table_PRO <- data.frame(aov.results_PRO)
print(anova.table_PRO)
```
Check the p.adj values for the main effects (Treatment and Time) and their Interaction.<br>

**Question**: What conclusions can you make from the ANOVA table? Is there a significant two-way interaction between Treatment and Timepoint?

## Task 11. 
Run a Levene test to check the Homogeneity of variance assumption. <br>
What you need to do is run Levene Tests separately on just the between subjects Independent Variable (Timepoint). To do this we need to group the data by the variable `Timepoint`.
```{r}
pro.data %>%
  group_by(Timepoint) %>%
  levene_test(PRO~Treatment) %>% 
  print()
```
**Question**: Is the equality of variance assumptions met for each timepoint? 


## Task 12. Post-Hoc Tests
**Procedure for a significant two-way interaction**. <br>

- A significant two-way interaction indicates that the impact that one factor has on the outcome variable depends on the level of the other factor (and vice versa). There are two ways we could look at the Treatment x Timepoint interaction: We could break it down by looking at the effect of Treatment at each level of Timepoint, or, we could look at the effect of Timepoint separately for Control and Heat Stressed plants.
The Post-Hoc Test for Mixed ANOVA consist of essentially running a series of *t*-tests and then applying a post-hoc test such as the Bonferroni Correction or Benjamini & Hochberg to avoid type-I errors.<br>

A) Pairwise comparisons between Treatment levels: The first group of pairwise comparisons refers to the treatment differences for each timepoint. 
```{r}
pwc_PRO <- pro.data %>%
  group_by(Timepoint) %>%
  pairwise_t_test(PRO ~ Treatment, 
                  p.adjust.method = "BH")

  pwc_PRO 
```
**Note** The above pairwise comparisons are the most important for our experiment as they show at which timepoints the progoitrin concentration for the treated samples was statistically significant from the control. 


B) Pairwise comparison between timepoints at each Treatment level:
```{r}
pwc2_Time_PRO <- pro.data %>%
  group_by(Treatment) %>%
  pairwise_t_test(PRO ~ Timepoint, paired = TRUE, p.adjust.method = "BH")

  pwc2_Time_PRO
```

## Task 13
Create boxplots with significant differences indicated. 
```{r}
bxp_PRO <- ggboxplot(pro.data, x = "Timepoint", y = "PRO", color = "Treatment", ylab="PRO conc.(ng/g)",
                     palette = c("#00AFBB", "#E7B800", "#FC4E07"), main= "PRO conc. after outliers substitution",
                     add.params = list(size = 0.9), 
                     bxp.errorbar = TRUE, bxp.errorbar.width = 0.15)

pwc_PRO <- pwc_PRO %>% add_xy_position(x = "Timepoint")

bxp_PRO + stat_pvalue_manual(pwc_PRO, tip.length = 0, hide.ns = TRUE) +
  labs(subtitle = get_test_label(pro.anova, detailed = TRUE), caption = get_pwc_label(pwc_PRO))
```









